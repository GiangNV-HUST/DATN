@startuml sequence_uc5_truy_van
!theme plain
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center
skinparam shadowing false

actor User
boundary "Discord Bot" as Bot
control "Root Agent" as Root
participant "MCP Wrapper" as Wrapper
participant "MCP Client" as Client
participant "MCP Server" as Server
database "Database" as DB

User -> Bot: "GiÃ¡ VCB hiá»‡n táº¡i?"
activate Bot

Bot -> Root: AI Router phÃ¢n loáº¡i
activate Root
Root -> Root: Mode: DIRECT_QUERY

Root -> Wrapper: get_stock_data(VCB)
activate Wrapper

Wrapper -> Client: call_tool
activate Client
Client -> Client: Check cache: HIT âœ…

Client --> Wrapper: Cached result (fast)
deactivate Client

Wrapper --> Root: Stock data
deactivate Wrapper

Root -> Root: Format response

Root --> Bot: "VCB: 95,500 (+2.36%)"
deactivate Root

Bot --> User: ğŸ’µ VCB: 95,500 VNÄ (+2.36%)
deactivate Bot

== Cache MISS scenario ==

User -> Bot: "GiÃ¡ HPG hiá»‡n táº¡i?"
activate Bot

Bot -> Root: AI Router
activate Root

Root -> Wrapper: get_stock_data(HPG)
activate Wrapper
Wrapper -> Client: call_tool
activate Client
Client -> Client: Cache MISS âŒ

Client -> Server: get_stock_data
activate Server

Server -> DB: SELECT latest price
activate DB
DB --> Server: HPG data
deactivate DB

Server --> Client: Result
deactivate Server

Client -> Client: Save to cache (60s)

Client --> Wrapper: Fresh data
deactivate Client
Wrapper --> Root: Result
deactivate Wrapper

Root --> Bot: Response
deactivate Root

Bot --> User: ğŸ’µ HPG: 24,300 VNÄ (-0.82%)
deactivate Bot

@enduml
