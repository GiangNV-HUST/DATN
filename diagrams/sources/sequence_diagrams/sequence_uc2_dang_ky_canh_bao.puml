@startuml sequence_uc2_dang_ky_canh_bao
!theme plain
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center
skinparam shadowing false

actor User
boundary "Discord Bot" as Bot
control "Root Agent" as Root
control "Alert Agent" as Alert
participant "MCP Wrapper" as Wrapper
participant "MCP Client" as Client
participant "MCP Server" as Server
database "Database" as DB

User -> Bot: "Alert khi VCB > 100"
activate Bot

Bot -> Root: Phân loại intent
activate Root
Root -> Root: Intent: CREATE_ALERT

Root -> Alert: Route to AlertManager
activate Alert
Alert -> Alert: Extract: VCB, price, >100

Alert -> Wrapper: create_alert(VCB, 100)
activate Wrapper

Wrapper -> Client: call_tool(create_alert)
activate Client

Client -> Server: stdio: create_alert()
activate Server

Server -> Server: Validate symbol, value

Server -> DB: INSERT alert
activate DB
DB --> Server: alert_id: 42
deactivate DB

Server -> Server: Schedule monitoring

Server --> Client: Success, alert_id: 42
deactivate Server

Client --> Wrapper: Result
deactivate Client

Wrapper --> Alert: Success
deactivate Wrapper

Alert -> Alert: Format response

Alert --> Root: Response text
deactivate Alert

Root --> Bot: Final response
deactivate Root

Bot --> User: ✅ Tạo cảnh báo #42 thành công
deactivate Bot

@enduml
