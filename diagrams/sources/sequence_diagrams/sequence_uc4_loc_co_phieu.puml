!pragma charset UTF-8
@startuml sequence_uc4_loc_co_phieu
!theme plain
skinparam backgroundColor #FEFEFE
skinparam shadowing false
skinparam defaultFontName "Times New Roman"

title UC4: L·ªçc c·ªï phi·∫øu (Stock Screening)

actor User
participant "Root Agent" as Root
participant "Screener Specialist" as Screener
participant "Multi-Model System" as Models
participant "MCP Server" as MCP
participant "TCBS API" as TCBS
database "PostgreSQL" as DB

== Initialization ==
User -> Root: "L·ªçc c·ªï phi·∫øu RSI<30, PE<15"
activate Root
Root -> Screener: Route to ScreenerSpecialist
activate Screener

== Parse Criteria ==
Screener -> Models: Parse screening criteria\n(Gemini Flash)
activate Models
Models --> Screener: Parsed: RSI<30, PE<15
deactivate Models

== Data Screening ==
Screener -> MCP: screen_stocks(criteria)
activate MCP
MCP -> MCP: Check cache: MISS

MCP -> TCBS: POST /stock/screen
activate TCBS
TCBS --> MCP: Stock list from exchange
deactivate TCBS

MCP -> DB: Filter by RSI & PE
activate DB
DB --> MCP: Technical + fundamental data
deactivate DB

MCP -> MCP: Merge & filter\n‚Üí 18 stocks matched
MCP -> MCP: Save to cache (10 min)
MCP --> Screener: 18 matched stocks
deactivate MCP

== Analysis ==
Screener -> Models: Analyze & rank\n(Claude Sonnet 4.5)
activate Models
Models --> Screener: Ranked list with insights
deactivate Models

== Result ==
Screener --> Root: Screening result
deactivate Screener
Root --> User: üìä T√¨m th·∫•y 18 m√£ th·ªèa ƒëi·ªÅu ki·ªán:\n\nTop 5:\n1. HPG: RSI 28 | PE 9.5 ‚≠ê\n2. VHM: RSI 25 | PE 12.3\n3. MSN: RSI 29 | PE 14.8\n4. POW: RSI 27 | PE 11.2\n5. GAS: RSI 26 | PE 13.5\n\nüí° 18 c·ªï phi·∫øu ƒëang oversold
deactivate Root

note over User, DB
  **Screening Process:**
  ‚Ä¢ Parse user criteria with AI
  ‚Ä¢ Fetch from TCBS API
  ‚Ä¢ Filter with DB technical data
  ‚Ä¢ Cache results (10 min TTL)
  ‚Ä¢ Rank by AI analysis

  **Common Filters:**
  ‚Ä¢ Technical: RSI, MACD, MA
  ‚Ä¢ Fundamental: PE, ROE, EPS
  ‚Ä¢ Volume & liquidity metrics
end note

@enduml
