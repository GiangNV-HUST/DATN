!pragma charset UTF-8
@startuml sequence_uc9_discovery
!theme plain
skinparam backgroundColor #FEFEFE
skinparam shadowing false
skinparam defaultFontName "Times New Roman"

title UC9: TÃ¬m kiáº¿m & khÃ¡m phÃ¡ cá»• phiáº¿u (Stock Discovery)

actor User
participant "Root Agent" as Root
participant "Discovery Specialist" as Discovery
participant "Multi-Model System" as Models
participant "MCP Server" as MCP
database "PostgreSQL" as DB

== Initialization ==
User -> Root: "TÃ¬m cá»• phiáº¿u cÃ´ng nghá»‡ tiá»m nÄƒng"
activate Root
Root -> Discovery: Route to DiscoverySpecialist
activate Discovery

== Phase 1: Initial Search ==
Discovery -> MCP: Search tech stocks
activate MCP
MCP -> DB: SELECT stocks WHERE sector='Technology'
activate DB
DB --> MCP: 28 candidates
deactivate DB
MCP --> Discovery: Stock list
deactivate MCP

Discovery -> Models: Analyze & filter\n(Claude Opus 4.5)
activate Models
Models --> Discovery: 20 qualified stocks
deactivate Models

== Phase 2: Criteria Filtering ==
Discovery -> MCP: Apply filters\n(PE < 15, ROE > 15%, Growth > 20%)
activate MCP
MCP -> DB: Filter by criteria
activate DB
DB --> MCP: 12 stocks passed
deactivate DB
MCP --> Discovery: Filtered list
deactivate MCP

Discovery -> Models: Format screening results\n(Gemini Flash)
activate Models
Models --> Discovery: 12 stocks formatted
deactivate Models

== Phase 3: Deep Analysis ==
Discovery -> MCP: Get detailed data\n(12 stocks)
activate MCP
MCP -> DB: Fetch OHLCV + fundamentals + news
activate DB
DB --> MCP: Detailed stock data
deactivate DB
MCP --> Discovery: Stock data
deactivate MCP

== Phase 4: Ranking ==
Discovery -> MCP: Calculate composite scores
activate MCP
MCP -> DB: Get news & sentiment
activate DB
DB --> MCP: News data
deactivate DB
MCP -> MCP: Compute scores:\nâ€¢ Technical (30%)\nâ€¢ Fundamental (40%)\nâ€¢ Sentiment (30%)
MCP --> Discovery: Ranked scores
deactivate MCP

Discovery -> Models: Analyze rankings\n(Claude Opus 4.5)
activate Models
Models --> Discovery: Top 10 stocks with insights
deactivate Models

Discovery -> Models: Format final response\n(Gemini Flash)
activate Models
Models --> Discovery: Formatted report
deactivate Models

== Result ==
Discovery --> Root: Discovery report
deactivate Discovery
Root --> User: ðŸ” TÃ¬m tháº¥y 10 cá»• phiáº¿u cÃ´ng nghá»‡:\n\nTop 3:\n1. FPT: Score 8.5/10\n2. VGI: Score 8.2/10\n3. CMG: Score 7.9/10\n\nâœ“ Growth > 25%\nâœ“ PE < 12\nâœ“ Positive sentiment
deactivate Root

note over User, DB
  **Discovery Pipeline:**
  â€¢ Initial search: 28 candidates
  â€¢ Quality filter: 20 stocks
  â€¢ Criteria filter: 12 stocks
  â€¢ Final ranking: Top 10

  **Multi-Model Usage:**
  â€¢ Claude Opus: Deep analysis & ranking
  â€¢ Gemini Flash: Fast formatting

  **Scoring Components:**
  â€¢ Technical indicators (30%)
  â€¢ Fundamental metrics (40%)
  â€¢ Market sentiment (30%)
end note

@enduml
