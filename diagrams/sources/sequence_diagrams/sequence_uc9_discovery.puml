@startuml sequence_uc9_discovery
!theme plain
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center
skinparam shadowing false

actor User
boundary "Discord Bot" as Bot
control "Root Agent" as Root
control "Discovery Specialist" as Discovery
entity "Task Classifier" as Classifier
entity "Model Selector" as Selector
participant "Gemini 2.0 Flash" as Flash
participant "Claude Opus 4.5" as Opus
entity "Usage Tracker" as Tracker
participant "MCP Wrapper" as Wrapper
participant "MCP Client" as Client
participant "MCP Server" as Server
database "Database" as Data

User -> Bot: "TÃ¬m cá»• phiáº¿u cÃ´ng nghá»‡ tiá»m nÄƒng"
activate Bot

Bot -> Root: AI Router
activate Root
Root -> Root: Agent: DiscoverySpecialist

Root -> Discovery: Route request
activate Discovery

Discovery -> Classifier: classify_task
activate Classifier
Classifier --> Discovery: 4 sub-tasks
deactivate Classifier

Discovery -> Selector: get_models_for_tasks
activate Selector
Selector --> Discovery: Model allocation
deactivate Selector

Discovery -> Wrapper: search_potential_stocks
activate Wrapper
Wrapper -> Client: call_tool
activate Client
Client -> Server: Query
activate Server
Server -> Data: SELECT tech stocks
activate Data
Data --> Server: 28 candidates
deactivate Data
Server --> Client: List
deactivate Server
Client --> Wrapper: Result
deactivate Client
deactivate Wrapper

Discovery -> Opus: Analyze & filter 28 stocks
activate Opus
Opus --> Discovery: 20 candidates
deactivate Opus

Discovery -> Tracker: Track Opus
activate Tracker
deactivate Tracker

Discovery -> Wrapper: filter_by_criteria
activate Wrapper
Wrapper -> Client: call_tool
activate Client
Client -> Server: Apply filters
activate Server
Server -> Data: Filter by PE, ROE, growth
activate Data
Data --> Server: 12 passed
deactivate Data
Server --> Client: Filtered
deactivate Server
Client --> Wrapper: Result
deactivate Client
deactivate Wrapper

Discovery -> Flash: Format screening results
activate Flash
Flash --> Discovery: 12 stocks
deactivate Flash

Discovery -> Tracker: Track Flash
activate Tracker
deactivate Tracker

Discovery -> Wrapper: Get detailed data (12 stocks)
activate Wrapper
Wrapper -> Client: call_tool
activate Client
Client -> Server: Fetch data
activate Server
Server -> Data: SELECT stock data
activate Data
Data --> Server: Detailed data
deactivate Data
Server --> Client: Result
deactivate Server
Client --> Wrapper: Data
deactivate Client
deactivate Wrapper

Discovery -> Wrapper: rank_stocks_by_score
activate Wrapper
Wrapper -> Client: call_tool
activate Client
Client -> Server: Calculate scores
activate Server
Server -> Data: Get news & sentiment
activate Data
Data --> Server: News
deactivate Data
Server -> Server: Compute final scores
Server --> Client: Ranked list
deactivate Server
Client --> Wrapper: Result
deactivate Client
deactivate Wrapper

Discovery -> Opus: Analyze rankings
activate Opus
Opus --> Discovery: Top 10 ranked
deactivate Opus

Discovery -> Tracker: Track Opus
activate Tracker
deactivate Tracker

Discovery -> Flash: Format response
activate Flash
Flash --> Discovery: Formatted text
deactivate Flash

Discovery -> Tracker: Track Flash
activate Tracker
Tracker --> Discovery: Complete
deactivate Tracker

Discovery -> Discovery: Combine results

Discovery --> Root: Complete report
deactivate Discovery

Root --> Bot: Response
deactivate Root

Bot --> User: ğŸ” TÃ¬m tháº¥y 10 cá»• phiáº¿u cÃ´ng nghá»‡
deactivate Bot

@enduml
