@startuml sequence_uc1_xac_thuc
!theme plain
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center
skinparam shadowing false

actor "User" as User
boundary "Discord Bot" as Bot
control "Root Agent\n(HybridOrchestrator)" as Root
participant "MCP Wrapper" as Wrapper
participant "MCP Client\n(Enhanced)" as Client
participant "MCP Server" as Server
database "Database\n(session table)" as DB

User -> Bot: Gửi tin nhắn "Tôi muốn xem danh báo"
activate Bot

Bot -> Bot: Kiểm tra session\nexists in memory?
Bot -> Root: Yêu cầu xác thực\nuser_id, session_id
activate Root

Root -> Wrapper: Gọi MCP tool:\n**get_user_session**(user_id)
activate Wrapper

Wrapper -> Wrapper: Bridge:\nAsync → Sync\n(ThreadPoolExecutor)

Wrapper -> Client: call_tool(\n  "get_user_session",\n  {"user_id": "123456"}\n)
activate Client

Client -> Client: Check cache\n(cache miss)

Client -> Server: stdio communication:\nget_user_session(user_id)
activate Server

Server -> DB: SELECT * FROM sessions\nWHERE user_id = $1\nAND expires_at > NOW()
activate DB

DB --> Server: session data or None
deactivate DB

Server --> Client: {"session_id": "abc123",\n "user_id": "123456",\n "authenticated": true}
deactivate Server

Client -> Client: Save to cache\n(TTL: 300s)

Client --> Wrapper: Result
deactivate Client

Wrapper --> Root: Session data
deactivate Wrapper

Root -> Root: Validate session:\n✅ Authenticated\n✅ Not expired

Root --> Bot: Authentication\nSuccessful
deactivate Root

Bot --> User: ✅ Xác thực thành công!\nBạn có thể sử dụng hệ thống.
deactivate Bot

note right of Client
  **Enhanced MCP Client Features:**
  • Client-side caching (5 min TTL)
  • Request deduplication
  • Circuit breaker pattern
  • Retry with exponential backoff
end note

@enduml