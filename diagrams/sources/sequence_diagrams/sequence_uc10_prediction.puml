!pragma charset UTF-8
@startuml sequence_uc10_prediction
!theme plain
skinparam backgroundColor #FFFFFF
skinparam shadowing false
skinparam defaultFontName "Times New Roman"

title UC10: D·ª± ƒëo√°n gi√° c·ªï phi·∫øu (Stock Price Prediction)

actor User
participant "Root Agent" as Root
participant "Prediction Agent" as Prediction
participant "Claude Sonnet 4.5" as Claude
participant "MCP Server" as MCP
participant "Ensemble System" as Ensemble
database "PostgreSQL" as DB

== Initialization ==
User -> Root: "D·ª± ƒëo√°n gi√° VCB 3 ng√†y t·ªõi"
activate Root
Root -> Prediction: Route to PredictionAgent
activate Prediction
Prediction -> Claude: Execute with Claude Sonnet 4.5
activate Claude

== Data Preparation ==
Claude -> MCP: predict_stock_price\n(ticker="VCB", horizon="3day")
activate MCP
MCP -> DB: Get historical data\n(1000 days, 60+ indicators)
activate DB
DB --> MCP: OHLCV + features
deactivate DB

MCP -> MCP: Feature engineering:\n‚Ä¢ Technical (RSI, MACD, BB)\n‚Ä¢ Moving averages\n‚Ä¢ Volume & sentiment

== Ensemble Prediction ==
MCP -> Ensemble: Run ensemble models
activate Ensemble
Ensemble -> Ensemble: PatchTST: 102,300 VND\nLSTM+Attention: 101,800 VND
Ensemble -> Ensemble: Meta-model combines:\n‚Ä¢ PatchTST: 52.5%\n‚Ä¢ LSTM: 47.5%\n‚Üí Base: 102,050 VND
deactivate Ensemble

== Scenario Adjustment ==
MCP -> DB: Check market conditions
activate DB
DB --> MCP: Foreign flow 97.3% (>95%)
deactivate DB

MCP -> MCP: Apply scenario handlers:\n‚Ä¢ Foreign Flow: -3%\n‚Üí Final: 98,989 VND (+0.50%)

MCP -> MCP: Calculate confidence: 80%\n(Model agreement + MAPE)

== Result ==
MCP --> Claude: Prediction result:\n98,989 VND | +0.50% | Confidence 80%
deactivate MCP

Claude -> Claude: Format analysis & recommendation
Claude --> Prediction: Complete report
deactivate Claude

Prediction --> Root: Prediction data
deactivate Prediction

Root --> User: üìä D·ª± ƒëo√°n gi√° VCB (3 ng√†y):\n98,989 VND (+0.50%)\n\nƒê·ªô tin c·∫≠y: 80%\nKhuy·∫øn ngh·ªã: HOLD\n\nPh√¢n t√≠ch:\n- Base ensemble: 102,050 VND\n- ƒêi·ªÅu ch·ªânh: -3% (Foreign flow)\n- Room ngo·∫°i: 97.3% (g·∫ßn ƒë·∫ßy)
deactivate Root

note over User, DB
  **Ensemble Stacking (2 Models):**
  ‚Ä¢ PatchTST: Transformer-based
  ‚Ä¢ LSTM+Attention: Sequential patterns
  ‚Ä¢ Meta-model: MLPRegressor

  **Scenario Handlers:**
  ‚Ä¢ News Shock (-5% to +8%)
  ‚Ä¢ Market Crash (-15% to -8%)
  ‚Ä¢ Foreign Flow (-3% to +2%)
  ‚Ä¢ VN30 Adjustment (-5% to +5%)
  ‚Ä¢ Margin Call (-10% to -5%)

  **Confidence Calculation:**
  ‚Ä¢ Model agreement: 85%
  ‚Ä¢ Historical MAPE: 1.99%
  ‚Ä¢ Scenario impact: Medium
end note

@enduml
