!pragma charset UTF-8
@startuml sequence_uc7_chart
!theme plain
skinparam backgroundColor #FEFEFE
skinparam shadowing false
skinparam defaultFontName "Times New Roman"

title UC7: Xem biá»ƒu Ä‘á»“ giÃ¡ & indicators (Price Chart)

actor User
participant "Root Agent" as Root
participant "Analysis Specialist" as Analysis
participant "MCP Server" as MCP
database "PostgreSQL" as DB

== Initialization ==
User -> Root: "Chart VCB 30 ngÃ y"
activate Root
Root -> Analysis: Route to AnalysisSpecialist
activate Analysis

== Data Retrieval ==
Analysis -> Analysis: Parse: VCB, 30 days, candlestick

Analysis -> MCP: get_price_history\n(ticker="VCB", days=30)
activate MCP
MCP -> MCP: Check cache: MISS

MCP -> DB: SELECT OHLCV + indicators
activate DB
DB --> MCP: 30 days data:\nâ€¢ OHLC + Volume\nâ€¢ MA5, MA20, MA50\nâ€¢ RSI, MACD
deactivate DB

MCP -> MCP: Cache (TTL: 120s)
MCP --> Analysis: Price history with indicators
deactivate MCP

== Chart Generation ==
Analysis -> Analysis: Return data to Bot for local chart generation

Analysis --> Root: Chart data
deactivate Analysis

Root -> Root: Generate chart (matplotlib):\nâ€¢ Subplot 1: Candlestick + MA\nâ€¢ Subplot 2: Volume bars\nâ€¢ Subplot 3: RSI indicator\nâ€¢ Subplot 4: MACD histogram

== Result ==
Root --> User: ðŸ“ˆ Biá»ƒu Ä‘á»“ VCB - 30 ngÃ y\n\n[Chart image attached]\n\nðŸ“Š PhÃ¢n tÃ­ch nhanh:\nâ€¢ Xu hÆ°á»›ng: TÄƒng â†—ï¸\nâ€¢ MA5 > MA20 (Golden cross)\nâ€¢ RSI: 58.2 (Neutral)\nâ€¢ MACD: Positive crossover\nâ€¢ Volume: TÄƒng 15% vs TB\n\nðŸ’¡ TÃ­n hiá»‡u ká»¹ thuáº­t tÃ­ch cá»±c
deactivate Root

note over User, DB
  **Chart Components (4 subplots):**
  
  1. Price + Moving Averages
     - Candlestick (OHLC)
     - MA5, MA20, MA50 lines
  
  2. Volume
     - Green bars (price up)
     - Red bars (price down)
  
  3. RSI (Relative Strength Index)
     - Overbought (70) / Oversold (30)
  
  4. MACD
     - MACD vs Signal line
     - Histogram

  **Implementation:**
  - Data from MCP Server (cached)
  - Chart generated locally in Bot
  - Faster than server-side rendering
end note

@enduml
