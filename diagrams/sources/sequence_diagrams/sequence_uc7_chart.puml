@startuml sequence_uc7_chart
!theme plain
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center
skinparam shadowing false

actor "User" as User
boundary "Discord Bot" as Bot
control "Root Agent" as Root
control "Analysis Agent" as Analysis
participant "MCP Wrapper" as Wrapper
participant "MCP Client" as Client
participant "MCP Server" as Server
database "Database" as DB

User -> Bot: "Chart VCB 30 ngÃ y"
activate Bot

Bot -> Root: AI Router
activate Root

Root -> Root: Decision:\nAgent: AnalysisSpecialist\nDirect Mode possible,\nbut use Agent for context

Root -> Analysis: Route request
activate Analysis

Analysis -> Analysis: Parse:\n- symbol: "VCB"\n- days: 30\n- chart_type: "candlestick"

== Láº¥y dá»¯ liá»‡u giÃ¡ ==

Analysis -> Wrapper: ðŸ“Š **get_price_history**(\n  ticker="VCB",\n  days=30\n)
activate Wrapper
Wrapper -> Client: call_tool(...)
activate Client
Client -> Client: Check cache (miss)
Client -> Server: get_price_history
activate Server
Server -> DB: SELECT time, open, high, low, close,\n       volume, ma5, ma20, ma50,\n       rsi, macd_main, macd_signal\nFROM stock_prices_1d\nWHERE ticker = 'VCB'\n  AND time >= NOW() - INTERVAL '30 days'\nORDER BY time ASC
activate DB
DB --> Server: 30 rows
deactivate DB
Server --> Client: Price data (30 days)
deactivate Server
Client -> Client: Cache (TTL: 120s)
Client --> Wrapper: Price history
deactivate Client
Wrapper --> Analysis: Data
deactivate Wrapper

== Táº¡o biá»ƒu Ä‘á»“ trong Bot ==

Analysis --> Root: Return data to Bot\nfor chart generation
deactivate Analysis

Root --> Bot: Price data
deactivate Root

Bot -> Bot: **Local chart generation**\nusing matplotlib/discord.py:\n\n1. Create figure (14x10)\n2. Subplot 1: Candlestick + MA\n3. Subplot 2: Volume bars\n4. Subplot 3: RSI indicator\n5. Subplot 4: MACD histogram\n6. Style: dark theme\n7. Save to BytesIO buffer

Bot -> Bot: Create Discord File:\nfile = discord.File(\n  buffer,\n  filename="VCB_chart_30d.png"\n)

Bot --> User: ðŸ“ˆ **Biá»ƒu Ä‘á»“ VCB - 30 ngÃ y**\n\n[Attached: VCB_chart_30d.png]\n\nðŸ“Š **PhÃ¢n tÃ­ch nhanh:**\nâ€¢ Xu hÆ°á»›ng: TÄƒng â†—ï¸\nâ€¢ MA5 > MA20 (Golden cross)\nâ€¢ RSI: 58.2 (Neutral)\nâ€¢ MACD: Positive crossover\nâ€¢ Volume: TÄƒng 15% vs TB\n\nðŸ’¡ TÃ­n hiá»‡u ká»¹ thuáº­t tÃ­ch cá»±c.\nDÃ¹ng "phÃ¢n tÃ­ch VCB" Ä‘á»ƒ xem chi tiáº¿t hÆ¡n.
deactivate Bot

note right of Bot #LightYellow
  **Chart Generation Options:**

  Option 1: MCP Server (centralized)
  â€¢ MCP tool: generate_chart_from_data
  â€¢ Pros: Consistent styling, caching
  â€¢ Cons: Network overhead

  Option 2: Discord Bot (local) âœ…
  â€¢ Direct matplotlib in bot code
  â€¢ Pros: Faster, no network call
  â€¢ Cons: Code duplication if multiple bots

  Current implementation uses Option 2
  for better performance.
end note

note over Bot, DB #LightCyan
  **Chart includes 4 subplots:**

  1. Price + Moving Averages
     - Candlestick (OHLC)
     - MA5, MA20, MA50 lines

  2. Volume
     - Green bars (price up)
     - Red bars (price down)

  3. RSI (Relative Strength Index)
     - Line chart
     - Overbought (70) / Oversold (30) zones

  4. MACD (Moving Average Convergence Divergence)
     - MACD line vs Signal line
     - Histogram (difference)
end note

@enduml