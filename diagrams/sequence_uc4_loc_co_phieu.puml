@startuml sequence_uc4_loc_co_phieu
!theme plain
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center
skinparam shadowing false

actor User
boundary "Discord Bot" as Bot
control "Root Agent" as Root
control "Screener Agent" as Screener
participant "MCP Wrapper" as Wrapper
participant "MCP Client" as Client
participant "MCP Server" as Server
participant "TCBS API" as TCBS
database "Database" as DB

User -> Bot: "Lá»c cá»• phiáº¿u RSI<30, PE<15"
activate Bot

Bot -> Root: AI Router
activate Root
Root -> Root: Target: ScreenerSpecialist

Root -> Screener: Route request
activate Screener
Screener -> Screener: Parse criteria

Screener -> Wrapper: screen_stocks(conditions)
activate Wrapper

Wrapper -> Client: call_tool(screen_stocks)
activate Client
Client -> Client: Check cache: MISS

Client -> Server: screen_stocks
activate Server

Server -> TCBS: POST /stock/screen
activate TCBS
TCBS --> Server: Stock list
deactivate TCBS

Server -> DB: SELECT with RSI filter
activate DB
DB --> Server: Technical data
deactivate DB

Server -> Server: Merge & filter

Server --> Client: 18 stocks matched
deactivate Server

Client -> Client: Save to cache (10 min)

Client --> Wrapper: Result
deactivate Client

Wrapper --> Screener: Stock list
deactivate Wrapper

Screener -> Screener: Format response

Screener --> Root: Formatted result
deactivate Screener

Root --> Bot: Response
deactivate Root

Bot --> User: ğŸ“Š TÃ¬m tháº¥y 18 mÃ£ thá»a Ä‘iá»u kiá»‡n
deactivate Bot

@enduml
