@startuml database_erd_complete
!theme plain
skinparam backgroundColor #FEFEFE
skinparam shadowing false
skinparam linetype ortho

' ===================================================
' COMPLETE DATABASE ERD - ALL RELATIONSHIPS
' Showing full architecture with financial tables
' ===================================================

skinparam class {
    BackgroundColor<<core>> #E3F2FD
    BackgroundColor<<financial>> #FFF3E0
    BackgroundColor<<user>> #E8F5E9
    BackgroundColor<<hybrid>> #F3E5F5
    BackgroundColor<<cache>> #FFF9C4
    BorderColor #1976D2
    ArrowColor #1976D2
}

' ===================================================
' CORE: Stock Information (Master Table)
' ===================================================

entity information <<core>> {
    **ticker
    ---
    exchange
    company_name
    industry
    website
    company_profile
    established_year
}

' ===================================================
' TIME-SERIES DATA (Hypertables - No FK)
' ===================================================

entity stock_prices_1m <<core>> {
    ⏰ time
    **ticker
    ---
    open
    high
    low
    close
    volume
}

entity stock_prices_1d <<core>> {
    ⏰ time
    **ticker
    ---
    open, high, low, close
    volume
    ma5, ma10, ma20, ma50
    rsi, macd_main, macd_signal
}

entity stock_prices_3d_predict <<core>> {
    ⏰ time
    **ticker
    ---
    close_next_1
    close_next_2
    close_next_3
}

entity stock_prices_48d_predict <<core>> {
    ⏰ time
    **ticker
    ---
    close_next_1..48
}

' ===================================================
' FINANCIAL DATA (Has FK to information)
' ===================================================

entity balance_sheet <<financial>> {
    **ticker
    **year
    **quarter
    ---
    total_assets
    total_resources
    current_assets
    cash_and_cash_equivalents
}

entity cash_flow <<financial>> {
    **ticker
    **year
    **quarter
    ---
    cash_flows_from_financial_activities
    dividends_paid
    interest_paid
}

entity income_statement <<financial>> {
    **ticker
    **year
    **quarter
    ---
    attribute_to_parent_company
    cost_of_sales
    eps_basic
}

entity ratio <<financial>> {
    **ticker
    **year
    **quarter
    ---
    roe
    roa
    pe
    pb
    eps
    gross_margin
}

' ===================================================
' USER INTERACTIONS
' ===================================================

entity alert <<user>> {
    ⚷ id
    ---
    **ticker
    user_id
    alert_type
    condition
    price_value
    is_active
}

entity subscribe <<user>> {
    ⚷ id
    ---
    user_id
    **ticker
    created_at
    is_active
}

' ===================================================
' HYBRID SYSTEM - NEW TABLES
' ===================================================

entity sessions <<hybrid>> {
    **session_id
    ---
    user_id
    user_name
    authenticated
    expires_at
    metadata
}

entity user_preferences <<hybrid>> {
    **user_id
    ---
    user_name
    risk_tolerance
    investment_horizon
    capital
    preferred_sectors
    max_single_stock_allocation
}

entity ai_usage_logs <<hybrid>> {
    ⚷ id
    ---
    user_id
    use_case
    agent_name
    model_name
    input_tokens
    output_tokens
    cost_usd
    execution_time_ms
}

entity portfolios <<hybrid>> {
    ⚷ id
    ---
    **user_id
    name
    tickers[]
    allocations[]
    total_value
    risk_level
    created_by_ai_model
}

entity query_cache <<cache>> {
    **cache_key
    ---
    query_type
    cached_data
    expires_at
    hit_count
}

' ===================================================
' RELATIONSHIPS
' ===================================================

' Stock Master -> Time-Series (Logical only - hypertables)
information ||..o{ stock_prices_1m : "logical"
information ||..o{ stock_prices_1d : "logical"
information ||..o{ stock_prices_3d_predict : "logical"
information ||..o{ stock_prices_48d_predict : "logical"

' Stock Master -> Financial (FK enforced)
information ||--o{ balance_sheet : "FK"
information ||--o{ cash_flow : "FK"
information ||--o{ income_statement : "FK"
information ||--o{ ratio : "FK"

' Stock Master -> User Interactions
information ||--o{ alert : "FK"
information ||..o{ subscribe : "no FK"

' Hybrid System (User-based)
user_preferences ||..o{ portfolios : "logical"
user_preferences ||..o{ ai_usage_logs : "logical"
sessions ||..o{ ai_usage_logs : "logical"

' ===================================================
' LEGEND
' ===================================================

legend right
  **Relationship Types:**
  ||--o{ : FK constraint (enforced)
  ||..o{ : Logical relationship (no FK)

  **Table Types:**
  • Core (blue): Stock master & time-series
  • Financial (orange): Fundamental data
  • User (green): User interactions
  • Hybrid (purple): Multi-model system
  • Cache (yellow): Performance optimization

  **Design Decisions:**
  • Hypertables: No FK for insert performance
  • Subscribe: No FK to allow any ticker
  • Hybrid tables: No FK for loose coupling
  • Financial: FK enforced for data integrity
endlegend

@enduml
