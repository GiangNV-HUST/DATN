@startuml sequence_uc8_tu_van_dau_tu
!theme plain
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center
skinparam shadowing false

actor User
boundary "Discord Bot" as Bot
control "Root Agent" as Root
control "Investment Planner" as Planner
entity "Task Classifier" as Classifier
entity "Model Selector" as Selector
participant "Gemini Flash" as Flash
participant "Gemini Pro" as Pro
participant "Claude Sonnet" as Claude
participant "GPT-4o" as GPT4
entity "Usage Tracker" as Tracker
participant "MCP Wrapper" as Wrapper
participant "MCP Client" as Client
participant "MCP Server" as Server
database "Database" as DB

User -> Bot: "TÆ° váº¥n danh má»¥c 500tr, rá»§i ro TB"
activate Bot

Bot -> Root: AI Router
activate Root
Root -> Root: Agent: InvestmentPlanner

Root -> Planner: Route request
activate Planner

Planner -> Classifier: classify_task
activate Classifier
Classifier --> Planner: 7 sub-tasks
deactivate Classifier

Planner -> Selector: get_models_for_workflow
activate Selector
Selector --> Planner: Model allocation
deactivate Selector

Planner -> Wrapper: gather_profile(user)
activate Wrapper
Wrapper -> Client: call_tool
activate Client
Client -> Server: Get profile
activate Server
Server -> DB: SELECT user_profiles
activate DB
DB --> Server: Data
deactivate DB
Server --> Client: Profile
deactivate Server
Client --> Wrapper: Result
deactivate Client
deactivate Wrapper

Planner -> Flash: Summarize profile
activate Flash
Flash --> Planner: Summary ($0.000012)
deactivate Flash

Planner -> Tracker: Track Flash
activate Tracker
deactivate Tracker

Planner -> Wrapper: search_potential_stocks
activate Wrapper
Wrapper -> Client: call_tool
activate Client
Client -> Server: Query
activate Server
Server -> DB: SELECT candidates
activate DB
DB --> Server: 45 stocks
deactivate DB
Server --> Client: List
deactivate Server
Client --> Wrapper: Result
deactivate Client
deactivate Wrapper

Planner -> Claude: Analyze & filter 45 stocks
activate Claude
Claude --> Planner: 20 candidates ($0.025)
deactivate Claude

Planner -> Tracker: Track Claude
activate Tracker
deactivate Tracker

Planner -> Wrapper: filter_stocks
activate Wrapper
Wrapper -> Client: call_tool
activate Client
Client -> Server: Apply filters
activate Server
Server -> DB: Filter
activate DB
DB --> Server: 12 passed
deactivate DB
Server --> Client: Filtered
deactivate Server
Client --> Wrapper: Result
deactivate Client
deactivate Wrapper

Planner -> Pro: Format filtered results
activate Pro
Pro --> Planner: 12 stocks ($0.00008)
deactivate Pro

Planner -> Tracker: Track Pro
activate Tracker
deactivate Tracker

Planner -> Wrapper: Get stock data (6 stocks)
activate Wrapper
Wrapper -> Client: call_tool (6x)
activate Client
Client --> Wrapper: Stock data
deactivate Client
deactivate Wrapper

Planner -> Claude: Deep analysis (6 stocks data)
activate Claude
Claude --> Planner: Analysis ($0.0285)
deactivate Claude

Planner -> Tracker: Track Claude
activate Tracker
deactivate Tracker

Planner -> Wrapper: calculate_allocation
activate Wrapper
Wrapper -> Client: call_tool
activate Client
Client -> Server: Markowitz optimization
activate Server
Server --> Client: Optimal weights
deactivate Server
Client --> Wrapper: Result
deactivate Client
deactivate Wrapper

Planner -> GPT4: Generate allocation strategy
activate GPT4
GPT4 --> Planner: Portfolio ($0.022)
deactivate GPT4

Planner -> Tracker: Track GPT-4o
activate Tracker
deactivate Tracker

Planner -> GPT4: Entry strategy
activate GPT4
GPT4 --> Planner: DCA plan ($0.0185)
deactivate GPT4

Planner -> Tracker: Track GPT-4o
activate Tracker
deactivate Tracker

Planner -> GPT4: Risk management
activate GPT4
GPT4 --> Planner: Stop loss plan ($0.0175)
deactivate GPT4

Planner -> Tracker: Track GPT-4o
activate Tracker
Tracker --> Planner: Total: $0.1326
deactivate Tracker

Planner -> Planner: Combine all phases

Planner --> Root: Complete plan
deactivate Planner

Root --> Bot: Response
deactivate Root

Bot --> User: ðŸ“Š Káº¿ hoáº¡ch Ä‘áº§u tÆ° 6 cá»• phiáº¿u\n(Cost: $0.1326)
deactivate Bot

@enduml
