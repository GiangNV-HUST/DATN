@startuml sequence_uc3_subscription
!theme plain
skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center
skinparam shadowing false

actor User
boundary "Discord Bot" as Bot
control "Root Agent" as Root
control "Subscription Mgr" as SubMgr
participant "MCP Wrapper" as Wrapper
participant "MCP Client" as Client
participant "MCP Server" as Server
database "Database" as DB

User -> Bot: "Subscribe VCB"
activate Bot

Bot -> Root: AI Router
activate Root
Root -> Root: Agent: SubscriptionManager

Root -> SubMgr: Route request
activate SubMgr
SubMgr -> SubMgr: Extract: VCB, subscribe

SubMgr -> Wrapper: create_subscription(VCB)
activate Wrapper

Wrapper -> Client: call_tool(...)
activate Client

Client -> Server: create_subscription
activate Server

Server -> DB: Check duplicate
activate DB
DB --> Server: NULL (OK)
deactivate DB

Server -> DB: INSERT subscription
activate DB
DB --> Server: subscription_id: 789
deactivate DB

Server -> Server: Add to monitoring queue

Server --> Client: Success, id: 789
deactivate Server

Client --> Wrapper: Result
deactivate Client

Wrapper --> SubMgr: Success
deactivate Wrapper

SubMgr --> Root: Response
deactivate SubMgr

Root --> Bot: Final response
deactivate Root

Bot --> User: ✅ Đã theo dõi VCB thành công
deactivate Bot

@enduml
